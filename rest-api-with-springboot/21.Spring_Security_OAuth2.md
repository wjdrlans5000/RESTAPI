# 스프링 시큐리티 OAuth 2 설정: 인증 서버 설정
- OAuth2 인증 방법
    - Spring OAuth2 에서 지원하는 6가지 방법중 2가지를 사용하여 인증 서비스를 지원 한다.
    - Password와 Refresh Token 방식

- Password
    - Spring OAuth2가 지원하는 방법중 하나
    - Twitter 로그인시 ID와 PASSWORD를 직접 입력하여 여러 홉을 거칠 필요없이 바로 로그인하는것처럼 PASSWORD를 직접 입력하는 방식이기때문에 PASSWORD라는 이름이 붙음.
    - 최초 발급시 사용하는 방법
    - 홉이 1번만 일어난다.
        - 요청과 응답이 1쌍이다.
    - 보통의 방법은 홉이 많음
        - Token을 발급 받을수 있는 Token을 발급하고 Token을 사용해서 인증하도록 Redirection하는등 .. 홉이 많음
    - 이 인증 방식은 FirstClass 즉 인증을 제공하는 서비스들이 만든 앱이 사용하는 방식이다.
    - 서드파티 앱에서 사용하도록 허용해주어선 안된다.
        - 사용자의 정보 (ID, Password)를 직접 입력하기 때문에 보안적 문제가 있음.
    - 필요정보
        - GrantType, username, password
            - 파라미터 방식으로 전달
        - ClientId, ClientSecret
    - 장점
        - 홉이 적다.
        - access_token을 바로 발급할 수 있다.
        
- OAuth2 인증서버 테스트
```java
public class AuthServerConfigTest extends BaseControllerTest {
        
    @Autowired
    AccountService accountService;
    
    @Test
    @TestDescription("인증 토큰을 발급 받는 테스트")
    public void getAuthToken() throws Exception{
        //given
        String username = "gimunAccount gimun = @email.com";
        String password = "gimun";
        Account gimun = Account.builder()
                .email(username)
                .password(password)
                .roles(Set.of(AccountRole.ADMIN, AccountRole.USER))
                .build();
        this.accountService.saveAccount(gimun);

        String clientId  = "myApp";
        String clientSecret = "pass";
        
        //        - POST /oauth/token 으로 요청을 보내면 access_token 이 발급 되기를 기대한다.
        this.mockMvc.perform(post("/oauth/token")
                //        - 요청 HEADER에 httpBasic() 을 사용하여 basicOauth HEADER를 만들어 요청에 같이 보낸다.
                .with(httpBasic(clientId,clientSecret))
                //        - 요청 Parameter로 grant_type, username, password 을 전달한다.
                .param("username",username)
                .param("password",password)
                .param("grant_type","password")
        )
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("access_token").exists())
                
        ;
    }
    
}
```

- httpBasic() 메서드를 사용하려면 SpringSecurityTest가 의존성에 존재해야한다.
```xml
 <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <version>${spring-security.version}</version>
            <scope>test</scope>
        </dependency>

```
- 

```java
@Configuration
@EnableAuthorizationServer
public class AuthServerConfig extends AuthorizationServerConfigurerAdapter {

    @Autowired
    PasswordEncoder passwordEncoder;

    @Autowired
    AuthenticationManager authenticationManager;

    @Autowired
    AccountService accountService;

    @Autowired
    TokenStore tokenStore;

    @Override
    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {
        security.passwordEncoder(passwordEncoder);
    }

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.inMemory()
                .withClient("myApp")
                .authorizedGrantTypes("password","refresh_token")
                .scopes("read", "write")
                .secret(this.passwordEncoder.encode("pass"))
                .accessTokenValiditySeconds(10 * 60)
                .refreshTokenValiditySeconds(6 * 10 * 60);
        ;
    }

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
        endpoints.authenticationManager(authenticationManager)
                .userDetailsService(accountService)
                .tokenStore(tokenStore);
    }
}
```